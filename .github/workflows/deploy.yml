name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to DigitalOcean Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          envs: BENZINGA_API_KEY,SEEKING_ALPHA_API_KEY,RAPIDAPI_KEY,APIFY_API_TOKEN
          script: |
            cd /opt/openbb
            git pull origin main
            
            # Inject API keys into config file
            cat > config/user_settings.json << EOF
            {
              "credentials": {
                "benzinga_api_key": "${BENZINGA_API_KEY}",
                "seeking_alpha_api_key": "${SEEKING_ALPHA_API_KEY}"
              },
              "defaults": {
                "commands": {}
              },
              "preferences": {
                "data_directory": "/root/.openbb_platform/data",
                "export_directory": "/root/.openbb_platform/exports",
                "cache_directory": "/root/.openbb_platform/cache",
                "user_styles_directory": "/root/.openbb_platform/styles",
                "charting_extension": "openbb_charting",
                "table_style": "dark",
                "request_timeout": 30,
                "metadata": true,
                "output_type": "OBBject"
              }
            }
            EOF
            
            cd docker
            export RAPIDAPI_KEY="${RAPIDAPI_KEY}"
            export APIFY_API_TOKEN="${APIFY_API_TOKEN}"
            docker compose down
            docker compose up -d --build
            
            # Update nginx to proxy Bloomberg API
            cat > /etc/nginx/sites-available/openbb << 'NGINXEOF'
            server {
                listen 443 ssl;
                server_name _;
                ssl_certificate /etc/ssl/certs/openbb.crt;
                ssl_certificate_key /etc/ssl/private/openbb.key;
                
                location = /health {
                    return 200 '{"status": "ok"}';
                    add_header Content-Type application/json;
                }
                location = /api/v1/health {
                    return 200 '{"status": "ok"}';
                    add_header Content-Type application/json;
                }
                location /bloomberg/ {
                    proxy_pass http://127.0.0.1:6901/;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                }
                location / {
                    proxy_pass http://127.0.0.1:6900;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                }
            }
            NGINXEOF
            nginx -t && systemctl reload nginx
            
            # Open port 6901 if needed
            ufw allow 6901/tcp 2>/dev/null || true
            
            docker ps
        env:
          BENZINGA_API_KEY: ${{ secrets.BENZINGA_API_KEY }}
          SEEKING_ALPHA_API_KEY: ${{ secrets.SEEKING_ALPHA_API_KEY }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
